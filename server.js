/**
 * COMP4537 - Lab3
 * Victor Liu - A00971668 - set C
 * 
 * Server file for COMP4537
 * 
 * Note: code generated by ChatGPT has been commented where used.
 */

const http = require('http');
const path = require('path');
const url = require('url');
const { getDate, convertDateToString, formatMessageGreeting, getContentType, serveStaticFile, readFileContent, appendToFile } = require('./Lab3/modules/utils');
const { greeting } = require('./Lab3/lang/en/en');


// CHATGPT: Create the HTTP server
http.createServer((req, res) => {
    const parsedUrl = url.parse(req.url, true);

    // Root route ('/') to serve home.html
    if (parsedUrl.pathname === '/') {
        const filePath = path.join(__dirname, 'home.html');
        serveStaticFile(res, filePath, 'text/html');


    } else if (parsedUrl.pathname === '/COMP4537/labs/3/writeFile') {
        const text = parsedUrl.query.text || 'No text provided';
        appendToFile('./Lab3/assets/file.txt', text, (err) => { // Updated file path
            if (err) {
                console.log(err);
                res.writeHead(500, { 'Content-Type': 'text/plain' });
                res.end('Error writing to file');
            } else {
                res.writeHead(200, { 'Content-Type': 'text/plain' });
                res.end(`Appended to file: ${text}`);
            }
        });

        // Read from file route
    } else if (parsedUrl.pathname === '/COMP4537/labs/3/readFile/file.txt') {
        readFileContent('./Lab3/assets/file.txt', res); // Updated file path

    } else if (parsedUrl.pathname.startsWith('/COMP4537/labs/0')) {
        const filePath = path.join(__dirname, 'Lab0', parsedUrl.pathname.replace('/COMP4537/labs/0', ''));
        serveStaticFile(res, filePath, getContentType(filePath));
    } else if (parsedUrl.pathname.startsWith('/COMP4537/labs/1')) {
        const filePath = path.join(__dirname, 'Lab1', parsedUrl.pathname.replace('/COMP4537/labs/1', ''));
        serveStaticFile(res, filePath, getContentType(filePath));
    } else if (parsedUrl.pathname.startsWith('/COMP4537/labs/3') && parsedUrl.pathname !== '/COMP4537/labs/3/getDate') {
        const filePath = path.join(__dirname, 'Lab3', parsedUrl.pathname.replace('/COMP4537/labs/3', ''));
        serveStaticFile(res, filePath, getContentType(filePath));

        // Handle the /COMP4537/labs/3/getDate route
    } else if (parsedUrl.pathname === '/COMP4537/labs/3/getDate') {
        const name = parsedUrl.query.name || 'Guest'; // Get the 'name' query parameter or default to 'Guest'
        const currentDateTime = getDate(); // Get the current date and time
        console.log("API endpoint: /getDate, Name:", name);

        // Format the greeting message with the name and date
        const message = formatMessageGreeting(greeting, name, currentDateTime);

        // Check the Accept header to determine response type for API call
        if (req.headers.accept && req.headers.accept.includes('application/json')) {
            res.writeHead(200, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ message }));
        } else {
            res.writeHead(200, { 'Content-Type': 'text/html' });
            res.end(`<div style="color:blue;">${message}</div>`);
        }

    } else {
        res.writeHead(404, { 'Content-Type': 'text/plain' });
        res.end('404 Not Found');
    }
}).listen(3000, () => {
    console.log('Server is running on HTTPS and listening on port 3000');
});
